<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HSIE Referencing Generator — James Ruse</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,600;1,400&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --black: #0a0a0a;
    --white: #f8f7f4;
    --mid: #c8c4bc;
    --light: #e8e5df;
    --accent: #1a1a1a;
    --rule: #d4d0c8;
  }

  html { font-size: 16px; scroll-behavior: smooth; }

  body {
    background: var(--white);
    color: var(--black);
    font-family: 'EB Garamond', Georgia, serif;
    min-height: 100vh;
    line-height: 1.6;
  }

  /* HEADER */
  header {
    border-bottom: 2px solid var(--black);
    padding: 2rem 3rem;
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    gap: 2rem;
  }

  .logo-block { display: flex; flex-direction: column; gap: 0.1rem; }

  .school-tag {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    letter-spacing: 0.18em;
    text-transform: uppercase;
    color: var(--mid);
    font-weight: 300;
  }

  h1 {
    font-size: 1.9rem;
    font-weight: 500;
    letter-spacing: -0.02em;
    line-height: 1.1;
  }

  h1 em {
    font-style: italic;
    font-weight: 400;
  }

  .header-rule {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    color: var(--mid);
    letter-spacing: 0.1em;
  }

  /* MAIN */
  main {
    max-width: 820px;
    margin: 0 auto;
    padding: 3rem 2rem 5rem;
  }

  /* MODE TABS */
  .tabs {
    display: flex;
    border-bottom: 1.5px solid var(--black);
    margin-bottom: 2.5rem;
    gap: 0;
  }

  .tab {
    font-family: 'DM Mono', monospace;
    font-size: 0.72rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    padding: 0.75rem 1.8rem;
    cursor: pointer;
    border: none;
    background: none;
    color: var(--mid);
    border-bottom: 2.5px solid transparent;
    margin-bottom: -1.5px;
    transition: color 0.2s, border-color 0.2s;
  }

  .tab.active {
    color: var(--black);
    border-bottom-color: var(--black);
  }

  .tab:hover:not(.active) { color: var(--black); }

  /* PANELS */
  .panel { display: none; }
  .panel.active { display: block; }

  label {
    font-family: 'DM Mono', monospace;
    font-size: 0.68rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--mid);
    display: block;
    margin-bottom: 0.5rem;
  }

  input[type="text"], textarea {
    width: 100%;
    border: 1.5px solid var(--rule);
    background: var(--white);
    color: var(--black);
    font-family: 'DM Mono', monospace;
    font-size: 0.82rem;
    padding: 0.85rem 1rem;
    outline: none;
    transition: border-color 0.2s;
    border-radius: 0;
    -webkit-appearance: none;
  }

  input[type="text"]:focus, textarea:focus {
    border-color: var(--black);
  }

  textarea {
    resize: vertical;
    min-height: 180px;
    line-height: 1.6;
  }

  .input-note {
    font-family: 'DM Mono', monospace;
    font-size: 0.62rem;
    color: var(--mid);
    margin-top: 0.4rem;
    letter-spacing: 0.05em;
  }

  /* SOURCE TYPE */
  .type-row {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    margin-top: 0.5rem;
  }

  .type-chip {
    font-family: 'DM Mono', monospace;
    font-size: 0.62rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    padding: 0.35rem 0.8rem;
    border: 1.5px solid var(--rule);
    background: none;
    cursor: pointer;
    color: var(--mid);
    transition: all 0.15s;
  }

  .type-chip.selected, .type-chip:hover {
    border-color: var(--black);
    color: var(--black);
    background: var(--black);
    color: var(--white);
  }

  /* BUTTON */
  .btn {
    display: inline-flex;
    align-items: center;
    gap: 0.6rem;
    font-family: 'DM Mono', monospace;
    font-size: 0.72rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    padding: 0.85rem 2rem;
    background: var(--black);
    color: var(--white);
    border: none;
    cursor: pointer;
    margin-top: 1.5rem;
    transition: opacity 0.2s;
  }

  .btn:hover { opacity: 0.75; }
  .btn:disabled { opacity: 0.35; cursor: not-allowed; }

  .btn-outline {
    background: none;
    color: var(--black);
    border: 1.5px solid var(--black);
  }

  .btn-outline:hover { background: var(--black); color: var(--white); opacity: 1; }

  /* SPINNER */
  .spinner {
    width: 14px; height: 14px;
    border: 2px solid rgba(255,255,255,0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
    display: none;
  }

  .btn-outline .spinner { border-color: rgba(0,0,0,0.2); border-top-color: black; }
  .btn.loading .spinner { display: block; }

  @keyframes spin { to { transform: rotate(360deg); } }

  /* DIVIDER */
  hr {
    border: none;
    border-top: 1px solid var(--rule);
    margin: 2.5rem 0;
  }

  /* RESULTS */
  #results { margin-top: 2.5rem; }

  .results-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1.5px solid var(--black);
  }

  .results-title {
    font-size: 1rem;
    font-weight: 500;
    letter-spacing: 0.02em;
  }

  .results-count {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    color: var(--mid);
    letter-spacing: 0.08em;
  }

  /* REFERENCE LIST DISPLAY — mimics Word document */
  .ref-document {
    background: #fff;
    border: 1px solid var(--rule);
    padding: 3rem 3.5rem;
    font-family: 'Times New Roman', Times, serif;
    font-size: 11pt;
    line-height: 2; /* double spaced */
    color: #000;
    position: relative;
  }

  .ref-document-title {
    text-align: center;
    font-weight: bold;
    text-transform: uppercase;
    font-size: 11pt;
    margin-bottom: 0; /* part of double spacing */
    letter-spacing: 0;
  }

  .ref-entry {
    padding-left: 2.5em;
    text-indent: -2.5em;
    font-size: 11pt;
    line-height: 2;
    color: #000;
    font-style: normal;
  }

  .ref-entry a, .ref-url {
    color: #0563C1;
    text-decoration: underline;
    word-break: break-all;
  }

  .ref-entry em { font-style: italic; }

  /* individual ref cards */
  .ref-card {
    border: 1px solid var(--rule);
    margin-bottom: 1rem;
    overflow: hidden;
    animation: fadeUp 0.3s ease both;
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .ref-card-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.6rem 1rem;
    background: var(--light);
    border-bottom: 1px solid var(--rule);
    gap: 1rem;
  }

  .ref-card-url {
    font-family: 'DM Mono', monospace;
    font-size: 0.6rem;
    color: var(--mid);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 60%;
  }

  .ref-type-badge {
    font-family: 'DM Mono', monospace;
    font-size: 0.58rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    padding: 0.2rem 0.5rem;
    border: 1px solid var(--rule);
    color: var(--mid);
    flex-shrink: 0;
  }

  .ref-card-body {
    padding: 1rem 1.2rem;
    font-family: 'Times New Roman', Times, serif;
    font-size: 11pt;
    line-height: 2;
    color: #000;
    padding-left: calc(1.2rem + 2.5em);
    text-indent: -2.5em;
  }

  .ref-card-body a { color: #0563C1; text-decoration: underline; word-break: break-all; }

  .copy-single {
    font-family: 'DM Mono', monospace;
    font-size: 0.58rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    padding: 0.25rem 0.6rem;
    border: 1px solid var(--rule);
    background: none;
    cursor: pointer;
    color: var(--mid);
    transition: all 0.15s;
    flex-shrink: 0;
  }

  .copy-single:hover { border-color: var(--black); color: var(--black); }
  .copy-single.copied { border-color: #2d8a2d; color: #2d8a2d; }

  /* ERROR */
  .ref-error {
    font-family: 'DM Mono', monospace;
    font-size: 0.72rem;
    color: #a00;
    padding: 1rem;
    border: 1px solid #fcc;
    background: #fff8f8;
    margin-bottom: 1rem;
  }

  /* COPY ALL BUTTON AREA */
  .copy-all-area {
    margin-top: 1.5rem;
    display: flex;
    gap: 1rem;
    align-items: center;
    flex-wrap: wrap;
  }

  .copy-hint {
    font-family: 'DM Mono', monospace;
    font-size: 0.62rem;
    color: var(--mid);
  }

  /* STATUS BAR */
  .status {
    font-family: 'DM Mono', monospace;
    font-size: 0.68rem;
    color: var(--mid);
    margin-top: 1rem;
    min-height: 1.2em;
    letter-spacing: 0.05em;
  }

  .status.error { color: #a00; }
  .status.ok { color: #2d8a2d; }

  /* SECTION HEADING */
  .section-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.68rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--mid);
    margin-bottom: 1rem;
  }

  /* FOOTER */
  footer {
    border-top: 1px solid var(--rule);
    text-align: center;
    padding: 1.5rem;
    font-family: 'DM Mono', monospace;
    font-size: 0.6rem;
    color: var(--mid);
    letter-spacing: 0.08em;
  }

  @media (max-width: 600px) {
    header { padding: 1.5rem; flex-direction: column; }
    main { padding: 2rem 1.2rem; }
    .ref-document { padding: 1.5rem; }
    .tab { padding: 0.6rem 1rem; }
  }
</style>
</head>
<body>

<header>
  <div class="logo-block">
    <span class="school-tag">James Ruse Agricultural High School</span>
    <h1>HSIE <em>Reference</em> Generator</h1>
  </div>
  <span class="header-rule">APA 7th · HSIE Ed.</span>
</header>

<main>
  <!-- TABS -->
  <div class="tabs">
    <button class="tab active" onclick="switchTab('single')">Single URL</button>
    <button class="tab" onclick="switchTab('batch')">Batch / Paste Text</button>
  </div>

  <!-- SINGLE URL PANEL -->
  <div class="panel active" id="panel-single">
    <label for="single-url">URL to reference</label>
    <input type="text" id="single-url" placeholder="https://example.com/article" autocomplete="off" spellcheck="false">
    <p class="input-note">Paste any URL — the page will be read in real time to extract the actual author, date, title &amp; publisher.</p>

    <div style="margin-top:1.5rem;">
      <label>Source type hint <span style="font-size:0.55rem">(optional — helps accuracy)</span></label>
      <div class="type-row" id="type-chips">
        <button class="type-chip selected" data-type="auto">Auto-detect</button>
        <button class="type-chip" data-type="webpage">Webpage</button>
        <button class="type-chip" data-type="news">News Article</button>
        <button class="type-chip" data-type="journal">Journal Article</button>
        <button class="type-chip" data-type="government">Government Report</button>
        <button class="type-chip" data-type="youtube">YouTube</button>
        <button class="type-chip" data-type="podcast">Podcast</button>
        <button class="type-chip" data-type="book">Online Book</button>
      </div>
    </div>

    <button class="btn" id="btn-single" onclick="generateSingle()">
      <div class="spinner"></div>
      Generate Reference
    </button>

    <div class="status" id="status-single"></div>

    <div id="result-single"></div>
  </div>

  <!-- BATCH PANEL -->
  <div class="panel" id="panel-batch">
    <label for="batch-text">Paste your text</label>
    <textarea id="batch-text" placeholder="Paste any text here — essays, notes, bibliographies, reading lists. All URLs will be automatically detected and referenced."></textarea>
    <p class="input-note">URLs will be extracted and referenced in alphabetical order per HSIE guidelines.</p>

    <button class="btn" id="btn-batch" onclick="generateBatch()">
      <div class="spinner"></div>
      Extract &amp; Generate References
    </button>

    <div class="status" id="status-batch"></div>

    <div id="result-batch"></div>
  </div>
</main>
<div id="copy-canvas" style="position:absolute;left:-9999px;top:0;"></div>

<script>
// ===================== TAB SWITCHING =====================
function switchTab(tab) {
  document.querySelectorAll('.tab').forEach((t,i) => t.classList.toggle('active', ['single','batch'][i] === tab));
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.getElementById('panel-'+tab).classList.add('active');
}

// ===================== TYPE CHIPS =====================
let selectedType = 'auto';
document.querySelectorAll('.type-chip').forEach(chip => {
  chip.addEventListener('click', () => {
    document.querySelectorAll('.type-chip').forEach(c => c.classList.remove('selected'));
    chip.classList.add('selected');
    selectedType = chip.dataset.type;
  });
});

// ===================== URL EXTRACTION =====================
function extractURLs(text) {
  const pattern = /https?:\/\/[^\s"'<>\)\]\}]+/gi;
  const found = text.match(pattern) || [];
  // deduplicate
  return [...new Set(found.map(u => u.replace(/[.,;:!?]+$/, '')))];
}

// ===================== GUIDE CONTEXT =====================
const GUIDE = `You are an expert academic referencing assistant trained exclusively on the James Ruse Agricultural High School HSIE Referencing Guide (APA 7th edition variant).

REFERENCING RULES:
- References list is titled: REFERENCES (bold, centred, capitalised)
- Alphabetical by author surname or organisation name
- No bullet points or numbers
- Double-spaced
- 11-point Times New Roman font
- Hanging indent (indent second and subsequent lines)
- Capitalise only the first word of a book/article title + proper nouns + subtitle first word
- Journal/magazine/newspaper/website TITLES use proper case
- Italicise: book titles, journal titles, volume numbers, magazine/newspaper names, website names, film/show titles

FORMATS:
Book (one author): Author, A. (Year). *Title*. Publisher.
Book (two authors): Author, A., & Author, B. (Year). *Title*. Publisher.
Book (three+ authors): Author, A., Author, B., & Author, C. (Year). *Title*. Publisher.
Online book: Author, A. (Year). *Title*. Publisher. URL
Encyclopaedia: Author, A. (Year or n.d.). Title of entry. In *Encyclopaedia Name*. Retrieved Month Day, Year, from URL
Journal article: Author, A. (Year). Article title. *Journal Title*, *volume*(issue), page range. DOI/URL
Magazine/Newspaper: Author, A. (Year, Month Day). Article title. *Magazine/Newspaper*. URL
Online news: Author, A. (Year, Month Day). Article title. *Newspaper*. URL
Government report: Department Name. (Year, Month Day). *Title*. Publisher. URL
Webpage (individual): Author, A. (Year, Month Day). Title of webpage. *Website Name*. URL
Webpage (org): Organisation. (Year, Month Day). Title of webpage. *Website Name*. URL [omit website name if same as org]
YouTube: Author, A. (Year, Month Day). Title [Video]. *YouTube*. URL
Podcast episode: Host, A. (Host). (Year, Month Day). Episode title (No. X) [Audio Podcast Episode]. In *Podcast Title*. Company. URL
Film: Director, A. (Director). (Year). *Title* [Film]. Production Company.
TV series: Producer, A. (Executive Producer). (Year). *Title* [TV Series]. Company.

IMPORTANT OUTPUT FORMAT:
Return ONLY a JSON object with this structure:
{
  "type": "source type (e.g. Webpage, News Article, Journal Article, YouTube Video, Government Report, Online Book, etc.)",
  "reference": "The full formatted reference as plain text with HTML markup ONLY for italics using <em> tags and hyperlinks using <a href='...'>...</a> tags. Use exactly the HSIE format. Include the URL as a clickable link at the end where required.",
  "notes": "Any brief note about missing information or assumptions made (or empty string)"
}

For the reference field:
- Use <em>...</em> for all italic elements (book titles, journal names, volume numbers, website names)
- Use <a href="URL">URL</a> for URLs
- Follow hanging indent via the formatting — just output the text content
- If author is unknown, start with title
- If date is unknown, use (n.d.)
- Be precise about capitalisation rules`;

// ===================== API CALL (with web_search to read the actual page) =====================
async function fetchReference(url, typeHint) {
  const userMsg = `Use the web_search tool to fetch and read this URL: ${url}

Then generate a precise HSIE reference based on the ACTUAL content of the page — the real title, real author(s), real publication date, real publisher/organisation, and real website name as they appear on the page.
${typeHint && typeHint !== 'auto' ? `Source type hint: ${typeHint}` : ''}

Do NOT guess or infer from the URL alone. Read the page first, extract the metadata, then format the reference exactly per the HSIE guide.
If a field truly cannot be found after reading, use (n.d.) for date or start with title if no author.`;

  const resp = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 4000,
      system: GUIDE,
      tools: [{ type: 'web_search_20250305', name: 'web_search' }],
      messages: [{ role: 'user', content: userMsg }]
    })
  });

  if (!resp.ok) {
    const err = await resp.text();
    throw new Error(`API error ${resp.status}: ${err.slice(0,200)}`);
  }
  const data = await resp.json();

  // If model used tool_use, we need to send tool results back and get final answer
  let messages = [{ role: 'user', content: userMsg }];
  let finalData = data;

  if (data.stop_reason === 'tool_use') {
    // Build assistant message with all content blocks
    messages.push({ role: 'assistant', content: data.content });

    // Build tool results
    const toolResults = data.content
      .filter(b => b.type === 'tool_use')
      .map(b => ({
        type: 'tool_result',
        tool_use_id: b.id,
        content: b.type === 'tool_use' ? JSON.stringify(b.input) : ''
      }));

    // The search results are embedded in the response — we just need to send them back
    // Actually with web_search, the results come back as tool_result blocks we must forward
    const toolResultContent = data.content
      .filter(b => b.type === 'tool_result' || b.type === 'web_search_tool_result')
      .map(b => b);

    // Send back with tool results to get final formatted reference
    const resp2 = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 2000,
        system: GUIDE,
        tools: [{ type: 'web_search_20250305', name: 'web_search' }],
        messages: [
          { role: 'user', content: userMsg },
          { role: 'assistant', content: data.content }
        ]
      })
    });

    if (!resp2.ok) throw new Error(`API error on follow-up: ${resp2.status}`);
    finalData = await resp2.json();
  }

  // Extract text from final response
  const text = finalData.content
    .filter(b => b.type === 'text')
    .map(b => b.text)
    .join('');

  if (!text) throw new Error('No text response from API');

  // Parse JSON
  const clean = text.replace(/```json|```/g, '').trim();
  const start = clean.indexOf('{');
  const end = clean.lastIndexOf('}');
  if (start === -1) throw new Error('Could not parse reference JSON from response');
  return JSON.parse(clean.slice(start, end+1));
}

// ===================== SINGLE GENERATE =====================
async function generateSingle() {
  const url = document.getElementById('single-url').value.trim();
  if (!url) { setStatus('status-single', 'Please enter a URL.', 'error'); return; }
  if (!url.startsWith('http')) { setStatus('status-single', 'URL must start with http:// or https://', 'error'); return; }

  const btn = document.getElementById('btn-single');
  btn.disabled = true; btn.classList.add('loading');
  setStatus('status-single', 'Reading page and extracting metadata…');
  document.getElementById('result-single').innerHTML = '';

  try {
    const ref = await fetchReference(url, selectedType);
    const html = buildRefCard(url, ref, true);
    document.getElementById('result-single').innerHTML = html;
    setStatus('status-single', 'Reference generated.', 'ok');
    attachCopyButtons();
  } catch(e) {
    setStatus('status-single', 'Error: ' + e.message, 'error');
  } finally {
    btn.disabled = false; btn.classList.remove('loading');
  }
}

// ===================== BATCH GENERATE =====================
async function generateBatch() {
  const text = document.getElementById('batch-text').value.trim();
  if (!text) { setStatus('status-batch', 'Please paste some text containing URLs.', 'error'); return; }

  const urls = extractURLs(text);
  if (!urls.length) { setStatus('status-batch', 'No URLs found in the pasted text.', 'error'); return; }

  const btn = document.getElementById('btn-batch');
  btn.disabled = true; btn.classList.add('loading');
  setStatus('status-batch', `Found ${urls.length} URL${urls.length>1?'s':''}. Generating references…`);
  document.getElementById('result-batch').innerHTML = '';

  const results = [];
  for (let i = 0; i < urls.length; i++) {
    setStatus('status-batch', `Processing ${i+1} of ${urls.length}…`);
    try {
      const ref = await fetchReference(urls[i], 'auto');
      results.push({ url: urls[i], ref, ok: true });
    } catch(e) {
      results.push({ url: urls[i], error: e.message, ok: false });
    }
  }

  // Sort alphabetically by reference text
  results.sort((a, b) => {
    const ta = a.ok ? stripHtml(a.ref.reference) : a.url;
    const tb = b.ok ? stripHtml(b.ref.reference) : b.url;
    return ta.localeCompare(tb);
  });

  // Build output
  let html = `<div class="results-header">
    <span class="results-title">References</span>
    <span class="results-count">${results.filter(r=>r.ok).length} generated · ${urls.length} total</span>
  </div>`;

  // Document-style full reference list
  html += buildFullDocument(results);

  // Individual cards
  html += `<div style="margin-top:2rem"><p class="section-label">Individual Entries</p>`;
  results.forEach(r => {
    if (r.ok) html += buildRefCard(r.url, r.ref, false);
    else html += `<div class="ref-error">Could not generate reference for: ${escHtml(r.url)}<br>${escHtml(r.error)}</div>`;
  });
  html += '</div>';

  document.getElementById('result-batch').innerHTML = html;
  setStatus('status-batch', 'All references generated.', 'ok');
  attachCopyButtons();

  btn.disabled = false; btn.classList.remove('loading');
}

// ===================== BUILD FULL DOCUMENT =====================
function buildFullDocument(results) {
  const refs = results.filter(r => r.ok).map(r => r.ref.reference);
  
  let inner = `<p class="ref-document-title"><strong>REFERENCES</strong></p>`;
  refs.forEach(r => {
    inner += `<p class="ref-entry">${r}</p>`;
  });

  return `
  <div style="margin-bottom:1.5rem">
    <p class="section-label">Full Reference List</p>
    <div class="ref-document" id="full-doc">${inner}</div>
    <div class="copy-all-area">
      <button class="btn btn-outline" onclick="copyFullList()">
        <div class="spinner"></div>
        Copy Full List (Rich Text)
      </button>
      <span class="copy-hint">Preserves Times New Roman, italics, hyperlinks &amp; hanging indent</span>
    </div>
  </div>`;
}

// ===================== BUILD REF CARD =====================
function buildRefCard(url, ref, showCopyAll) {
  const shortUrl = url.length > 60 ? url.slice(0,57)+'…' : url;
  let html = `
  <div class="ref-card">
    <div class="ref-card-head">
      <span class="ref-card-url" title="${escHtml(url)}">${escHtml(shortUrl)}</span>
      <span class="ref-type-badge">${escHtml(ref.type)}</span>
      <button class="copy-single" data-ref="${escAttr(ref.reference)}" onclick="copySingle(this)">Copy</button>
    </div>
    <div class="ref-card-body">${ref.reference}</div>
  </div>`;

  if (showCopyAll) {
    html += `<div class="copy-all-area">
      <button class="btn btn-outline" onclick="copySingleRich('${escAttr(ref.reference)}')">
        Copy (Rich Text)
      </button>
      <span class="copy-hint">Preserves Times New Roman, italics &amp; hyperlinks</span>
    </div>`;
    if (ref.notes) {
      html += `<p style="font-family:'DM Mono',monospace;font-size:0.62rem;color:#888;margin-top:0.75rem">Note: ${escHtml(ref.notes)}</p>`;
    }
  }

  return html;
}

// ===================== COPY FUNCTIONS =====================
function attachCopyButtons() {}

function copySingle(btn) {
  const refHtml = btn.dataset.ref;
  copyRichText(wrapSingleRef(refHtml), () => {
    btn.textContent = 'Copied!';
    btn.classList.add('copied');
    setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 2000);
  });
}

function copySingleRich(refHtml) {
  copyRichText(wrapSingleRef(refHtml));
}

function copyFullList() {
  const doc = document.getElementById('full-doc');
  if (!doc) return;
  copyRichText(doc.innerHTML);
}

function wrapSingleRef(refHtml) {
  return `<p style="font-family:'Times New Roman',Times,serif;font-size:11pt;line-height:2;margin:0;padding-left:2.5em;text-indent:-2.5em;">${refHtml}</p>`;
}

function copyRichText(html, callback) {
  // Build a full styled blob
  const fullHtml = `
  <html><head><style>
    body { font-family: 'Times New Roman', Times, serif; font-size: 11pt; line-height: 2; color: #000; }
    p { margin: 0; padding-left: 2.5em; text-indent: -2.5em; line-height: 2; }
    em { font-style: italic; }
    a { color: #0563C1; }
    .title { text-align: center; font-weight: bold; text-transform: uppercase; padding-left: 0; text-indent: 0; }
  </style></head><body>${html}</body></html>`;

  try {
    const blob = new Blob([fullHtml], { type: 'text/html' });
    const plainBlob = new Blob([stripHtml(html)], { type: 'text/plain' });
    const item = new ClipboardItem({ 'text/html': blob, 'text/plain': plainBlob });
    navigator.clipboard.write([item]).then(() => {
      if (callback) callback();
      else showGlobalCopyFeedback();
    });
  } catch(e) {
    // Fallback: execCommand
    const canvas = document.getElementById('copy-canvas');
    canvas.innerHTML = fullHtml;
    const range = document.createRange();
    range.selectNodeContents(canvas);
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
    document.execCommand('copy');
    sel.removeAllRanges();
    canvas.innerHTML = '';
    if (callback) callback();
    else showGlobalCopyFeedback();
  }
}

function showGlobalCopyFeedback() {
  // brief visual flash
  const el = document.createElement('div');
  el.style.cssText = 'position:fixed;bottom:2rem;right:2rem;background:#0a0a0a;color:#f8f7f4;font-family:"DM Mono",monospace;font-size:0.7rem;letter-spacing:0.1em;padding:0.75rem 1.5rem;z-index:9999;text-transform:uppercase;';
  el.textContent = 'Copied to clipboard';
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 2500);
}

// ===================== UTILS =====================
function setStatus(id, msg, type) {
  const el = document.getElementById(id);
  el.textContent = msg;
  el.className = 'status' + (type ? ' '+type : '');
}

function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function escAttr(s) {
  return s.replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

function stripHtml(html) {
  const tmp = document.createElement('div');
  tmp.innerHTML = html;
  return tmp.textContent || tmp.innerText || '';
}

// Allow Enter key on single URL input
document.getElementById('single-url').addEventListener('keydown', e => {
  if (e.key === 'Enter') generateSingle();
});
</script>
</body>
</html>
