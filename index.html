<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HSIE Reference Generator — James Ruse Agricultural High School</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IM+Fell+English:ital@0;1&family=IBM+Plex+Mono:wght@400;500&family=IBM+Plex+Sans:ital,wght@0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --black: #0a0a0a;
    --white: #fafaf8;
    --mid: #e8e8e4;
    --light: #f2f2ef;
    --accent: #0a0a0a;
    --border: 1.5px solid #0a0a0a;
    --thin: 0.5px solid #c0c0ba;
    --font-serif: 'IM Fell English', Georgia, serif;
    --font-sans: 'IBM Plex Sans', system-ui, sans-serif;
    --font-mono: 'IBM Plex Mono', monospace;
  }

  html { font-size: 16px; scroll-behavior: smooth; }

  body {
    background: var(--white);
    color: var(--black);
    font-family: var(--font-sans);
    min-height: 100vh;
    line-height: 1.6;
  }

  /* ── HEADER ── */
  header {
    border-bottom: var(--border);
    padding: 2rem 0 0;
    position: relative;
    overflow: hidden;
  }
  .header-rule {
    height: 4px;
    background: var(--black);
    margin-bottom: 1px;
  }
  .header-rule-thin {
    height: 1px;
    background: var(--black);
    margin-bottom: 1.5rem;
  }
  .header-inner {
    max-width: 900px;
    margin: 0 auto;
    padding: 0 2rem;
  }
  .school-tag {
    font-family: var(--font-mono);
    font-size: 0.65rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: #555;
    margin-bottom: 0.5rem;
  }
  header h1 {
    font-family: var(--font-serif);
    font-size: clamp(2rem, 5vw, 3.2rem);
    font-weight: 400;
    font-style: italic;
    line-height: 1.1;
    letter-spacing: -0.01em;
    margin-bottom: 0.3rem;
  }
  header h1 span {
    font-style: normal;
  }
  .header-sub {
    font-family: var(--font-sans);
    font-size: 0.8rem;
    color: #555;
    letter-spacing: 0.05em;
    padding-bottom: 1.5rem;
    border-bottom: var(--thin);
    margin-bottom: 0;
  }
  .header-nav {
    display: flex;
    gap: 0;
    border-top: var(--thin);
    margin-top: 1rem;
  }
  .tab-btn {
    font-family: var(--font-mono);
    font-size: 0.7rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    padding: 0.75rem 1.5rem;
    background: none;
    border: none;
    border-right: var(--thin);
    cursor: pointer;
    color: #888;
    transition: all 0.15s;
    position: relative;
  }
  .tab-btn:first-child { border-left: var(--thin); }
  .tab-btn:hover { color: var(--black); background: var(--light); }
  .tab-btn.active {
    color: var(--white);
    background: var(--black);
  }

  /* ── MAIN ── */
  main {
    max-width: 900px;
    margin: 0 auto;
    padding: 2.5rem 2rem;
  }

  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* ── SECTION LABELS ── */
  .section-label {
    font-family: var(--font-mono);
    font-size: 0.65rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: #888;
    margin-bottom: 0.6rem;
    display: block;
  }

  /* ── INPUTS ── */
  .input-group {
    margin-bottom: 1.5rem;
  }
  textarea, input[type="text"], select {
    width: 100%;
    font-family: var(--font-mono);
    font-size: 0.82rem;
    padding: 0.85rem 1rem;
    border: var(--border);
    background: var(--white);
    color: var(--black);
    outline: none;
    transition: background 0.12s;
    appearance: none;
    resize: vertical;
  }
  textarea:focus, input[type="text"]:focus, select:focus {
    background: var(--light);
  }
  textarea { min-height: 120px; }

  /* ── BUTTONS ── */
  .btn {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    padding: 0.75rem 1.5rem;
    border: var(--border);
    cursor: pointer;
    transition: all 0.12s;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }
  .btn-primary {
    background: var(--black);
    color: var(--white);
  }
  .btn-primary:hover { background: #333; }
  .btn-secondary {
    background: var(--white);
    color: var(--black);
  }
  .btn-secondary:hover { background: var(--light); }
  .btn:disabled { opacity: 0.4; cursor: not-allowed; }

  .btn-row {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    align-items: center;
    margin-bottom: 1.5rem;
  }

  /* ── SOURCE TYPE SELECT ── */
  .type-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 0.5rem;
    margin-bottom: 1.5rem;
  }
  .type-card {
    border: var(--border);
    padding: 0.6rem 0.8rem;
    cursor: pointer;
    font-family: var(--font-mono);
    font-size: 0.68rem;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    transition: all 0.1s;
    background: var(--white);
    text-align: center;
    user-select: none;
  }
  .type-card:hover { background: var(--light); }
  .type-card.selected { background: var(--black); color: var(--white); }

  /* ── FORM FIELDS ── */
  .field-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  .field-grid.one { grid-template-columns: 1fr; }
  .field-grid.three { grid-template-columns: 1fr 1fr 1fr; }
  .field { display: flex; flex-direction: column; gap: 0.3rem; }
  label {
    font-family: var(--font-mono);
    font-size: 0.65rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: #666;
  }

  /* ── DIVIDER ── */
  .divider {
    border: none;
    border-top: var(--thin);
    margin: 2rem 0;
  }
  .divider-bold {
    border: none;
    border-top: var(--border);
    margin: 2rem 0;
  }

  /* ── OUTPUT ── */
  .output-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
    flex-wrap: wrap;
    gap: 0.5rem;
  }
  .output-title {
    font-family: var(--font-serif);
    font-size: 1.1rem;
    font-style: italic;
  }

  .references-box {
    border: var(--border);
    padding: 2.5rem 2.5rem;
    background: var(--white);
    min-height: 80px;
    position: relative;
  }

  .ref-list {
    font-family: 'Times New Roman', Times, serif;
    font-size: 11pt;
    color: #000;
    line-height: 2; /* double spaced */
  }
  .ref-list-title {
    font-family: 'Times New Roman', Times, serif;
    font-size: 11pt;
    font-weight: bold;
    text-align: center;
    text-transform: uppercase;
    margin-bottom: 0;
    line-height: 2;
  }
  .ref-entry {
    padding-left: 2em;
    text-indent: -2em;
    margin: 0;
    line-height: 2;
    word-break: break-word;
  }
  .ref-entry a { color: #000; text-decoration: none; }

  /* Empty state */
  .empty-state {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: #aaa;
    letter-spacing: 0.05em;
    padding: 1rem 0;
  }

  /* ── ITEM CARD (batch results) ── */
  .item-card {
    border: var(--thin);
    border-left: 3px solid var(--black);
    padding: 0.8rem 1rem;
    margin-bottom: 0.75rem;
    position: relative;
    animation: slideIn 0.2s ease;
  }
  @keyframes slideIn {
    from { opacity: 0; transform: translateY(4px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .item-card.error { border-left-color: #888; opacity: 0.7; }
  .item-url {
    font-family: var(--font-mono);
    font-size: 0.65rem;
    color: #888;
    margin-bottom: 0.3rem;
    word-break: break-all;
  }
  .item-ref {
    font-family: 'Times New Roman', Times, serif;
    font-size: 10.5pt;
    line-height: 1.8;
    padding-left: 2em;
    text-indent: -2em;
  }
  .item-status {
    font-family: var(--font-mono);
    font-size: 0.65rem;
    color: #888;
  }

  /* ── SPINNER ── */
  .spinner {
    display: inline-block;
    width: 12px;
    height: 12px;
    border: 1.5px solid #ccc;
    border-top-color: var(--black);
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ── GUIDE SECTION ── */
  .guide-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    margin-bottom: 2rem;
  }
  .guide-card {
    border: var(--thin);
    padding: 1.2rem;
  }
  .guide-card h3 {
    font-family: var(--font-mono);
    font-size: 0.7rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: var(--thin);
  }
  .guide-form {
    font-family: var(--font-mono);
    font-size: 0.68rem;
    color: #555;
    margin-bottom: 0.4rem;
    padding: 0.3rem 0.5rem;
    background: var(--light);
    border-left: 2px solid #ccc;
  }
  .guide-example {
    font-family: 'Times New Roman', Times, serif;
    font-size: 9.5pt;
    line-height: 1.7;
    padding-left: 1.5em;
    text-indent: -1.5em;
  }

  /* ── TOAST ── */
  #toast {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    background: var(--black);
    color: var(--white);
    font-family: var(--font-mono);
    font-size: 0.72rem;
    letter-spacing: 0.08em;
    padding: 0.7rem 1.2rem;
    border: var(--border);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
    z-index: 999;
  }
  #toast.show { opacity: 1; }

  /* ── PROGRESS ── */
  .progress-bar-wrap {
    height: 3px;
    background: var(--mid);
    margin-bottom: 1rem;
    display: none;
  }
  .progress-bar-fill {
    height: 100%;
    background: var(--black);
    width: 0%;
    transition: width 0.3s;
  }

  @media (max-width: 600px) {
    .field-grid { grid-template-columns: 1fr; }
    .field-grid.three { grid-template-columns: 1fr; }
    .guide-grid { grid-template-columns: 1fr; }
    .references-box { padding: 1.5rem 1rem; }
  }
</style>
</head>
<body>

<header>
  <div class="header-rule"></div>
  <div class="header-rule-thin"></div>
  <div class="header-inner">
    <div class="school-tag">James Ruse Agricultural High School · HSIE</div>
    <h1><span>Reference</span> Generator</h1>
    <p class="header-sub">HSIE 2026 Referencing Guideline Accurate - Human Checked - Service Worker Does NOT Work On School Wifi</p>
    <nav class="header-nav">
      <button class="tab-btn active" onclick="switchTab('single')">Single URL</button>
      <button class="tab-btn" onclick="switchTab('batch')">Batch / Paste Text</button>
      <button class="tab-btn" onclick="switchTab('guide')">Reference Guide</button>
    </nav>
  </div>
</header>

<main>

<!-- ─────────────── SINGLE URL ─────────────── -->
<div id="tab-single" class="tab-content active">
  <span class="section-label">Enter a URL to generate a reference</span>
  <div class="input-group">
    <input type="text" id="single-url" placeholder="https://example.com/article" 
           onkeydown="if(event.key==='Enter')generateSingle()">
  </div>

  <span class="section-label" style="margin-bottom:0.4rem">Source type</span>
  <div class="type-grid" id="single-type-grid">
    <div class="type-card selected" data-type="webpage" onclick="selectType(this)">Webpage</div>
    <div class="type-card" data-type="youtube" onclick="selectType(this)">YouTube</div>
    <div class="type-card" data-type="news" onclick="selectType(this)">News Article</div>
    <div class="type-card" data-type="magazine" onclick="selectType(this)">Magazine</div>
    <div class="type-card" data-type="journal" onclick="selectType(this)">Journal Article</div>
    <div class="type-card" data-type="gov" onclick="selectType(this)">Gov. Report</div>
    <div class="type-card" data-type="podcast" onclick="selectType(this)">Podcast</div>
    <div class="type-card" data-type="speech" onclick="selectType(this)">Speech</div>
  </div>

  <div class="btn-row">
    <button class="btn btn-primary" onclick="generateSingle()" id="single-btn">
      Generate Reference
    </button>
    <span id="single-status" class="item-status"></span>
  </div>

  <hr class="divider">

  <div class="output-header">
    <span class="output-title">Generated Reference</span>
    <button class="btn btn-secondary" onclick="copyRef('single-output')">Copy (with formatting)</button>
  </div>
  <div class="references-box" id="single-output-box">
    <div class="ref-list">
      <p class="ref-list-title">REFERENCES</p>
      <div id="single-output"><p class="empty-state">Your reference will appear here.</p></div>
    </div>
  </div>
</div>

<!-- ─────────────── BATCH ─────────────── -->
<div id="tab-batch" class="tab-content">
  <span class="section-label">Paste any text — URLs will be extracted automatically</span>
  <div class="input-group">
    <textarea id="batch-input" placeholder="Paste your text, bibliography draft, or list of URLs here. All URLs will be detected and referenced automatically. You can also paste just a list of URLs, one per line."></textarea>
  </div>

  <div class="btn-row">
    <button class="btn btn-primary" onclick="generateBatch()" id="batch-btn">Extract & Generate All</button>
    <button class="btn btn-secondary" onclick="clearBatch()">Clear</button>
    <span id="batch-status" class="item-status"></span>
  </div>

  <div class="progress-bar-wrap" id="batch-progress-wrap">
    <div class="progress-bar-fill" id="batch-progress-fill"></div>
  </div>

  <!-- Live item cards -->
  <div id="batch-items"></div>

  <div id="batch-output-section" style="display:none">
    <hr class="divider-bold">
    <div class="output-header">
      <span class="output-title">Complete Reference List</span>
      <button class="btn btn-secondary" onclick="copyRef('batch-ref-list')">Copy all (with formatting)</button>
    </div>
    <div class="references-box" id="batch-output-box">
      <div class="ref-list">
        <p class="ref-list-title">REFERENCES</p>
        <div id="batch-ref-list"></div>
      </div>
    </div>
  </div>
</div>



<!-- ─────────────── GUIDE ─────────────── -->
<div id="tab-guide" class="tab-content">
  <span class="section-label">Quick Reference — HSIE Referencing Guide</span>

  <div class="guide-grid">
    <div class="guide-card">
      <h3>Webpage — Individual Author</h3>
      <div class="guide-form">Author, A. (Year, Month Day). Title of webpage. Title of Website. URL</div>
      <p class="guide-example">Rae, J., & Thompson, S. (2017, May 5). Louis XVI. <em>Alpha History.</em> https://alphahistory.com/frenchrevolution/louis-xvi/</p>
    </div>
    <div class="guide-card">
      <h3>Webpage — Organisation Author</h3>
      <div class="guide-form">Organisation. (Year, Month Day). Title of webpage. Title of Website. URL</div>
      <p class="guide-example">A+E Networks. (2011, January 4). Cuban missile crisis. <em>History.com.</em> https://www.history.com/topics/cold-war/cuban-missile-crisis</p>
    </div>
    <div class="guide-card">
      <h3>News Article (Online)</h3>
      <div class="guide-form">Author, A. (Year, Month Day). Article title. Newspaper. DOI/URL</div>
      <p class="guide-example">Darby, A. (2004, August 10). Furious Butler quits as governor. <em>Sydney Morning Herald.</em> http://www.smh.com.au/articles/...</p>
    </div>
    <div class="guide-card">
      <h3>Journal Article</h3>
      <div class="guide-form">Author, A. (Year). Article title. Journal Title, volume(issue), page range. DOI/URL</div>
      <p class="guide-example">Wineburg, S. (2004). Crazy for history. <em>Journal of American History, 90</em>(4), 1401–1414. https://doi.org/10.2307/3660360</p>
    </div>
    <div class="guide-card">
      <h3>Book — One Author</h3>
      <div class="guide-form">Author, A. (Year). Title. Publisher.</div>
      <p class="guide-example">Evans, R. J. (2016). <em>The pursuit of power.</em> Penguin.</p>
    </div>
    <div class="guide-card">
      <h3>YouTube</h3>
      <div class="guide-form">Author, A. (Year, Month Day). Title [Video]. YouTube. URL</div>
      <p class="guide-example">Radio Free Europe. (2020, May 15). The death of Stalin: Unique propaganda footage shows dictator's funeral [Video]. <em>YouTube.</em> https://www.youtube.com/watch?v=eQo27EoLp_A</p>
    </div>
    <div class="guide-card">
      <h3>Government Report</h3>
      <div class="guide-form">Department Name. (Year, Month Day). Title of document. Publisher. URL</div>
      <p class="guide-example">President's Commission on the Assassination of President Kennedy. (1964). <em>Report of the President's Commission on the assassination of President Kennedy.</em> National Archives. https://...</p>
    </div>
    <div class="guide-card">
      <h3>Encyclopaedia</h3>
      <div class="guide-form">Author, A. (n.d.). Title of entry. In Encyclopaedia. Retrieved Month Day, Year, from URL</div>
      <p class="guide-example">Higonnet, P. L., & Popkin, J. D. (n.d.). The causes of the French revolution. In <em>Encyclopedia Britannica.</em> Retrieved February 16, 2022, from https://www.britannica.com/...</p>
    </div>
    <div class="guide-card">
      <h3>Speech (Audio Recording)</h3>
      <div class="guide-form">Author, A. (Year, Month Day). Title [Speech audio recording]. Publisher. URL</div>
      <p class="guide-example">King, M. L., Jr. (1963, August 28). I have a dream [Speech audio recording]. <em>American Rhetoric.</em> https://www.americanrhetoric.com/...</p>
    </div>
    <div class="guide-card">
      <h3>Podcast Episode</h3>
      <div class="guide-form">Author, A. (Host). (Year, Month Day). Episode title (No. X) [Audio Podcast Episode]. In Podcast Title. Company. URL</div>
      <p class="guide-example">Glass, I. (Host). (2011, August 12). Amusement park (No. 443) [Audio Podcast episode]. In <em>This American Life.</em> WEBZ Chicago. https://...</p>
    </div>
  </div>

  <hr class="divider">
  <span class="section-label">Formatting Rules</span>
  <div style="font-family: var(--font-mono); font-size: 0.72rem; line-height: 2; color: #444; background: var(--light); padding: 1.2rem 1.5rem; border: var(--thin);">
    · References section headed REFERENCES (bold, centred, capitalised)<br>
    · Alphabetical order by author surname or organisation name<br>
    · No bullet points or numbers<br>
    · Double-spaced throughout<br>
    · 11-point Times New Roman throughout<br>
    · Hanging indent (second and subsequent lines indented)<br>
    · Capitalise only first word of title + proper nouns + subtitle after colon<br>
    · Journal/magazine/newspaper publication names use proper case<br>
    · Italicise: book titles, journal names + volume numbers, newspaper names, website names<br>
    · No full stop after DOI/URL<br>
    · Remove hyperlinks for paper submissions; keep blue links for online
  </div>
</div>

</main>

<div id="toast">Copied to clipboard!</div>

<script>
// ══════════════════════════════════════════════
//  CONFIGURATION
// ══════════════════════════════════════════════


const WORKER_URL = 'https://hsie.adriankatsugachi.workers.dev/';

// Fallback CORS proxy (public, for development only)
const CORS_PROXY = 'https://corsproxy.io/?';

// ══════════════════════════════════════════════
//  TAB SWITCHING
// ══════════════════════════════════════════════


function switchTab(name) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
  event.target.classList.add('active');
}

function selectType(el) {
  el.closest('.type-grid').querySelectorAll('.type-card').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
}

// ══════════════════════════════════════════════
//  FETCH METADATA VIA WORKER
// ══════════════════════════════════════════════

async function fetchMeta(url) {
  // Try worker first
  try {
    const res = await fetch(WORKER_URL + '?url=' + encodeURIComponent(url));
    if (res.ok) return await res.json();
  } catch(e) {}

  // Fallback: CORS proxy + parse HTML
  try {
    const res = await fetch(CORS_PROXY + encodeURIComponent(url));
    if (!res.ok) throw new Error('fetch failed');
    const html = await res.text();
    return parseMetaFromHTML(html, url);
  } catch(e) {
    // Return minimal info from URL itself
    return parseFromURL(url);
  }
}

function parseMetaFromHTML(html, url) {
  const get = (pattern) => {
    const m = html.match(pattern);
    return m ? decodeEntities(m[1]?.trim()) : null;
  };
  const title =
    get(/<meta[^>]+property="og:title"[^>]+content="([^"]+)"/i) ||
    get(/<meta[^>]+content="([^"]+)"[^>]+property="og:title"/i) ||
    get(/<title[^>]*>([^<]+)<\/title>/i) || null;
  const author =
    get(/<meta[^>]+name="author"[^>]+content="([^"]+)"/i) ||
    get(/<meta[^>]+property="article:author"[^>]+content="([^"]+)"/i) || null;
  const dateRaw =
    get(/<meta[^>]+property="article:published_time"[^>]+content="([^"]+)"/i) ||
    get(/<meta[^>]+name="date"[^>]+content="([^"]+)"/i) ||
    get(/<time[^>]+datetime="([^"]+)"/i) || null;
  const siteName =
    get(/<meta[^>]+property="og:site_name"[^>]+content="([^"]+)"/i) || null;

  let year=null, month=null, day=null;
  if (dateRaw) {
    const d = new Date(dateRaw);
    if (!isNaN(d)) { year=d.getFullYear(); month=d.toLocaleString('en-US',{month:'long'}); day=d.getDate(); }
  }

  const urlObj = new URL(url);
  const hostname = urlObj.hostname.replace('www.','');
  let type = 'webpage';
  if (hostname.includes('youtube.com')||hostname.includes('youtu.be')) type='youtube';

  return { url, title, author, dateRaw, year, month, day, siteName, hostname, type };
}

function parseFromURL(url) {
  try {
    const u = new URL(url);
    const hostname = u.hostname.replace('www.','');
    let type = 'webpage';
    if (hostname.includes('youtube.com')||hostname.includes('youtu.be')) type='youtube';
    return { url, title: null, author: null, year: null, month: null, day: null, siteName: null, hostname, type };
  } catch { return { url, title: null, author: null, year: null, month: null, day: null, siteName: null, hostname: '', type: 'webpage' }; }
}

function decodeEntities(str) {
  if (!str) return str;
  return str.replace(/&amp;/g,'&').replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/&nbsp;/g,' ');
}

// ══════════════════════════════════════════════
//  REFERENCE FORMATTING (HSIE GUIDE)
// ══════════════════════════════════════════════

const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];

function toSentenceCase(str) {
  if (!str) return '';
  // Capitalise first letter, lowercase rest EXCEPT proper nouns (we preserve them)
  return str.charAt(0).toUpperCase() + str.slice(1);
}

function formatAuthorLastFirst(name) {
  if (!name) return null;
  name = name.trim();
  // If already "Last, F." format, return as is
  if (name.match(/^[A-Z][a-z]+,\s/)) return name;
  // Handle "First Last" → "Last, F."
  const parts = name.split(/\s+/);
  if (parts.length === 1) return parts[0];
  const last = parts[parts.length - 1];
  const initials = parts.slice(0, -1).map(p => p.charAt(0).toUpperCase() + '.').join(' ');
  return `${last}, ${initials}`;
}

function formatAuthors(authorStr) {
  if (!authorStr) return null;
  const names = authorStr.split(/;\s*|,\s*|\s+and\s+|\s+&\s+/).map(s => s.trim()).filter(Boolean);
  if (names.length === 1) return formatAuthorLastFirst(names[0]);
  if (names.length === 2) return formatAuthorLastFirst(names[0]) + ', & ' + formatAuthorLastFirst(names[1]);
  const all = names.map((n,i) => {
    if (i === names.length-1) return '& ' + formatAuthorLastFirst(n);
    return formatAuthorLastFirst(n);
  });
  return all.join(', ');
}

function isOrganisation(name) {
  if (!name) return false;
  // Heuristic: contains no comma (not "Last, F.") and has multiple words or is all caps / known pattern
  return !name.includes(',') && (name.split(' ').length > 1 || name === name.toUpperCase());
}

// Build HTML reference (with italic spans preserved for copy)
function buildRef(meta, typeOverride) {
  const type = typeOverride || meta.type || 'webpage';
  const url = meta.url || '';
  const title = toSentenceCase(meta.title) || 'Untitled';
  const siteName = meta.siteName || extractSiteNameFromURL(url);
  const year = meta.year || null;
  const month = meta.month || null;
  const day = meta.day || null;
  const authorStr = meta.author || null;

  const dateStr = year
    ? (month ? (day ? `${year}, ${month} ${day}` : `${year}, ${month}`) : `${year}`)
    : 'n.d.';

  const urlText = url;
  const it = (s) => `<em>${s}</em>`;

  // --- PRESERVED TYPES ---
  if (type === 'youtube') {
    const author = authorStr || siteName || extractSiteNameFromURL(url);
    return `${author}. (${dateStr}). ${toSentenceCase(title)} [Video]. ${it('YouTube.')} ${urlText}`;
  }

  if (type === 'journal') {
    const author = formatAuthors(authorStr); // REMOVED || siteName fallback
    const journal = meta.journal || siteName || 'Unknown Journal';
    const vol = meta.volume ? `, ${it(meta.volume)}` : '';
    const iss = meta.issue ? `(${meta.issue})` : '';
    const pages = meta.pages ? `, ${meta.pages}` : '';
    const doi = meta.doi ? ` ${meta.doi}` : (url ? ` ${url}` : '');
    
    if (author) {
      return `${author} (${dateStr}). ${toSentenceCase(title)}. ${it(journal)}${vol}${iss}${pages}.${doi}`;
    } else {
      // If no human author, start with Title (Correct HSIE/APA)
      return `${toSentenceCase(title)}. (${dateStr}). ${it(journal)}${vol}${iss}${pages}.${doi}`;
    }
  }

  if (type === 'news') {
    const author = formatAuthors(authorStr);
    const paper = siteName || extractSiteNameFromURL(url);
    if (author && author.toLowerCase() !== paper.toLowerCase()) {
      return `${author} (${dateStr}). ${toSentenceCase(title)}. ${it(paper + '.')} ${urlText}`;
    } else {
      return `${paper}. (${dateStr}). ${toSentenceCase(title)}. ${urlText}`;
    }
  }

  if (type === 'magazine') {
    const author = formatAuthors(authorStr);
    const mag = siteName || extractSiteNameFromURL(url);
    if (author && author.toLowerCase() !== mag.toLowerCase()) {
      return `${author} (${dateStr}). ${toSentenceCase(title)}. ${it(mag + '.')} ${urlText}`;
    } else {
      return `${mag}. (${dateStr}). ${toSentenceCase(title)}. ${urlText}`;
    }
  }

  if (type === 'gov') {
    const org = authorStr || siteName || 'Government Department';
    return `${org}. (${dateStr}). ${it(toSentenceCase(title) + '.')} ${urlText}`;
  }

  if (type === 'encyclopaedia') {
    const author = formatAuthors(authorStr);
    const enc = meta.encyclopaedia || siteName || extractSiteNameFromURL(url);
    const today = new Date();
    const retrieved = `Retrieved ${today.toLocaleString('en-US',{month:'long'})} ${today.getDate()}, ${today.getFullYear()}, from ${urlText}`;
    return author 
      ? `${author} (${dateStr}). ${toSentenceCase(title)}. In ${it(enc + '.')} ${retrieved}`
      : `${toSentenceCase(title)}. (${dateStr}). In ${it(enc + '.')} ${retrieved}`;
  }

  if (type === 'podcast') {
    const host = formatAuthors(authorStr) || 'Unknown Host';
    const podTitle = meta.podcastTitle || toSentenceCase(title);
    const company = meta.company || siteName || '';
    return `${host} (Host). (${dateStr}). ${it(podTitle)} [Audio Podcast]. ${company ? company + '.' : ''} ${urlText}`;
  }

  if (type === 'podcast-ep') {
    const host = formatAuthors(authorStr) || 'Unknown Host';
    const epTitle = toSentenceCase(title);
    const epNum = meta.episodeNum ? ` (No. ${meta.episodeNum})` : '';
    const podTitle = meta.podcastTitle || '';
    const company = meta.company || siteName || '';
    return `${host} (Host). (${dateStr}). ${epTitle}${epNum} [Audio Podcast Episode].${podTitle ? ` In ${it(podTitle + '.')}` : ''} ${company ? company + '.' : ''} ${urlText}`;
  }

  if (type === 'speech') {
    const speaker = formatAuthors(authorStr) || 'Unknown Speaker';
    const pub = meta.publisher || siteName || extractSiteNameFromURL(url);
    const format = meta.speechFormat || 'Speech audio recording';
    return `${speaker} (${dateStr}). ${toSentenceCase(title)} [${format}]. ${it(pub + '.')} ${urlText}`;
  }

  // --- PRESERVED REMAINING TYPES (Film, TV, Book) ---
  if (type === 'film') {
    const director = meta.director || authorStr || 'Unknown Director';
    return `${formatAuthors(director)} (Director). (${meta.year || 'n.d.'}). ${it(toSentenceCase(title) + '.')} [Film]. ${meta.publisher || siteName}.`;
  }
  if (type === 'tv-series') {
    return `${formatAuthors(meta.producer || authorStr || 'Unknown')} (Executive Producer). (${meta.yearRange || year || 'n.d.'}). ${it(toSentenceCase(title))} [TV Series]. ${meta.company || siteName}.`;
  }
  if (type === 'book') {
    return `${formatAuthors(meta.bookAuthor || authorStr) || 'Unknown Author'} (${dateStr}). ${it(toSentenceCase(meta.bookTitle || title) + '.')} ${meta.publisher || siteName}.`;
  }

  // --- DEFAULT FALLBACK ---
  const author = formatAuthors(authorStr); 
  const site = siteName || extractSiteNameFromURL(url);
  const siteIsDiffFromAuthor = author && author.toLowerCase() !== site.toLowerCase();

  if (author) {
    return `${author} (${dateStr}). ${toSentenceCase(title)}. ${siteIsDiffFromAuthor ? it(site + '.') : ''} ${urlText}`.replace(/\s+/g, ' ').trim();
  } else {
    return `${site}. (${dateStr}). ${toSentenceCase(title)}. ${urlText}`;
  }
}

function extractSiteNameFromURL(url) {
  try {
    const u = new URL(url);
    return u.hostname.replace('www.','').split('.')[0];
  } catch { return 'Website'; }
}

// Alphabetical sort key from a reference HTML string
function sortKey(refHtml) {
  const text = refHtml.replace(/<[^>]+>/g,'').trim();
  return text.toLowerCase().replace(/^[^a-z]+/,'');
}

// ══════════════════════════════════════════════
//  SINGLE URL
// ══════════════════════════════════════════════

async function generateSingle() {
  const url = document.getElementById('single-url').value.trim();
  if (!url) { showToast('Please enter a URL'); return; }
  const typeEl = document.querySelector('#single-type-grid .selected');
  const type = typeEl ? typeEl.dataset.type : 'webpage';

  const btn = document.getElementById('single-btn');
  const status = document.getElementById('single-status');
  btn.disabled = true;
  status.innerHTML = '<span class="spinner"></span> Fetching…';

  try {
    const meta = await fetchMeta(url);
    meta.type = type;
    const ref = buildRef(meta, type);
    document.getElementById('single-output').innerHTML = `<p class="ref-entry">${ref}</p>`;
    status.innerHTML = '✓ Done';
  } catch(e) {
    document.getElementById('single-output').innerHTML = `<p class="ref-entry" style="color:#888">Could not fetch metadata. Please use Manual Entry or check the URL.</p>`;
    status.innerHTML = 'Error';
  }
  btn.disabled = false;
}

// ══════════════════════════════════════════════
//  BATCH
// ══════════════════════════════════════════════

function extractURLs(text) {
  const pattern = /https?:\/\/[^\s<>"{}|\\^`\[\]']+/gi;
  const found = [...new Set(text.match(pattern) || [])];
  return found.map(u => u.replace(/[.,;:)]+$/, '')); // strip trailing punctuation
}

let batchRefs = [];

async function generateBatch() {
  const text = document.getElementById('batch-input').value;
  const urls = extractURLs(text);
  if (!urls.length) { showToast('No URLs found in text'); return; }

  const btn = document.getElementById('batch-btn');
  btn.disabled = true;
  batchRefs = [];
  document.getElementById('batch-items').innerHTML = '';
  document.getElementById('batch-output-section').style.display = 'none';

  const wrap = document.getElementById('batch-progress-wrap');
  const fill = document.getElementById('batch-progress-fill');
  wrap.style.display = 'block';

  const status = document.getElementById('batch-status');
  status.innerHTML = `Processing ${urls.length} URL${urls.length>1?'s':''}…`;

  for (let i = 0; i < urls.length; i++) {
    const url = urls[i];
    fill.style.width = ((i / urls.length) * 100) + '%';

    // Add pending card
    const card = document.createElement('div');
    card.className = 'item-card';
    card.id = 'card-' + i;
    card.innerHTML = `<div class="item-url">${url}</div><div class="item-status"><span class="spinner"></span> Fetching…</div>`;
    document.getElementById('batch-items').appendChild(card);
    card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

    try {
      const meta = await fetchMeta(url);
      const ref = buildRef(meta);
      batchRefs.push({ ref, url, key: sortKey(ref) });
      card.querySelector('.item-status').remove();
      card.innerHTML += `<div class="item-ref">${ref}</div>`;
    } catch(e) {
      batchRefs.push({ ref: null, url, key: url });
      card.classList.add('error');
      card.querySelector('.item-status').innerHTML = '⚠ Could not fetch — add manually';
    }
  }

  fill.style.width = '100%';
  setTimeout(() => { wrap.style.display = 'none'; fill.style.width = '0%'; }, 600);

  // Sort alphabetically & build combined list
  batchRefs.sort((a,b) => (a.key > b.key ? 1 : -1));
  const combined = batchRefs.filter(r => r.ref).map(r => `<p class="ref-entry">${r.ref}</p>`).join('');

  document.getElementById('batch-ref-list').innerHTML = combined || '<p class="empty-state">No references generated.</p>';
  document.getElementById('batch-output-section').style.display = 'block';
  document.getElementById('batch-output-section').scrollIntoView({ behavior: 'smooth' });

  btn.disabled = false;
  status.innerHTML = `✓ ${urls.length} URL${urls.length>1?'s':''} processed`;
}

function clearBatch() {
  document.getElementById('batch-input').value = '';
  document.getElementById('batch-items').innerHTML = '';
  document.getElementById('batch-output-section').style.display = 'none';
  document.getElementById('batch-status').innerHTML = '';
  batchRefs = [];
}

// ══════════════════════════════════════════════
//  COPY WITH FORMATTING
// ══════════════════════════════════════════════

async function copyRef(targetId) {
  const container = document.getElementById(targetId).closest('.references-box');
  if (!container) { showToast('Nothing to copy'); return; }

  // Build plain text version (APA-style, no HTML)
  const plainEntries = [...container.querySelectorAll('.ref-entry')].map(el => el.innerText).join('\n');
  const plainText = 'REFERENCES\n\n' + plainEntries;

  // Build RTF for Word compatibility (preserves italic, double-space, hanging indent)
  // We'll use the ClipboardItem API with both text/plain and text/html
  const htmlContent = container.innerHTML;

  // Wrap in a styled div for copy
  const wrapper = document.createElement('div');
  wrapper.style.fontFamily = 'Times New Roman, Times, serif';
  wrapper.style.fontSize = '11pt';
  wrapper.style.lineHeight = '2';
  wrapper.style.color = '#000';
  wrapper.innerHTML = htmlContent;

  try {
    const htmlBlob = new Blob([
      `<html><body><div style="font-family:'Times New Roman',Times,serif;font-size:11pt;line-height:2;color:#000">${htmlContent}</div></body></html>`
    ], { type: 'text/html' });
    const textBlob = new Blob([plainText], { type: 'text/plain' });
    await navigator.clipboard.write([
      new ClipboardItem({ 'text/html': htmlBlob, 'text/plain': textBlob })
    ]);
    showToast('Copied! Paste into Word to retain formatting.');
  } catch(e) {
    // Fallback
    try {
      await navigator.clipboard.writeText(plainText);
      showToast('Copied as plain text.');
    } catch(e2) {
      showToast('Copy failed — try selecting manually.');
    }
  }
}

// ══════════════════════════════════════════════
//  TOAST
// ══════════════════════════════════════════════

let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 3000);
}

// ── INIT ──
</script>
</body>
</html>
